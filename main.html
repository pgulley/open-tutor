<html>
	<head>
		<link rel="stylesheet" href="style.css">
		<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&family=Kode+Mono:wght@400..700&display=swap" rel="stylesheet">
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	</head>
	<body>

	<div id="app">
		<lesson v-for="l in lessons"
				:kc_options=l.kc_options
				@next_question=handleNext
				>
					
		</lesson>
	</div>

	<script>
	const { createApp, ref } = Vue

	app = createApp({
	  	data(){
	  		return{
	  			lessons:[]
	  		}
	  	},

	  	methods: {
	  		async getFirstLessons(){
				const res = await fetch("http://127.0.0.1:5000/get_recs");
				const finalRes = await res.json();
				this.lessons = [{kc_options:finalRes}]
	  		},
	  		async handleNext(){
	  			
	  			const res = await fetch("http://127.0.0.1:5000/get_recs");
				const finalRes = await res.json();
				console.log(finalRes)
				this.lessons.push({kc_options:finalRes})
				console.log(this.lessons)
	  		}
	  	},
	  	mounted(){
	  		this.getFirstLessons()
	  	}

	})

	app.component("lesson", {
	  	props:['kc_options'],
	  	template:`
		  	<div class="lesson">
				<div class="comfortaa lesson_header">
					Select a lesson
				</div>
				<KC v-for="k in kc_options "
						:title=k.title
						:id=k.id
						:is_active=true
					@selected='handleKcSelected'
				>
				</KC>
				<InnerLoop v-if="selected"
						 :kc=selected_kc
						 @next_question="handleNext">> 
				</InnerLoop>
			</div>`,
		mounted(){
			console.log(this.kc_options)
		},
		data(){
			return{
				selected:false,
				selected_kc:"",

			}
		},
		methods:{
			handleKcSelected(kc){
				if(!this.selected){
					this.selected_kc = kc
					this.selected = true
				}
			},
			handleNext(){
				this.$emit("next_question")
			}
		}
	})

	///UNDER CONSTRUCTION I GUESS
	app.component("LearningObjective",{
		props:["level", "status"],
		template:`<span class="material-symbols-outlined lo_icon" :class="status">{{ symbol_name() }}</span>`,
		methods:{
			symbol_name(){
				switch(this.level){
					case "knowledge":
						return "emoji_objects"
					case "understand":
						return "search_check"
					case "apply":
						return "architecture"
					case "analyze":
						return "psychology"
				}
			},
		}
	})

	app.component("KC", {
	  	props:["title", "id"],
	  	template:`<div class="task_hero" :style="{ 'background-color': bg }" @click="select">
			<div class="icon_column">
				<span class="material-symbols-outlined lo_icon icon_ok">emoji_objects</span>
				<span class="material-symbols-outlined lo_icon icon_active">search_check</span>
				<span class="material-symbols-outlined lo_icon">architecture</span>
				<span class="material-symbols-outlined lo_icon">psychology</span>
			</div>
			<div class="kc_title comfortaa">
				 {{ title }}
			</div>
		</div>`,
		data(){
			return{
				is_active:true,
				was_chosen: false,
				bg: ""
			}
		},
		methods:{
			getBg(){
				if(this.was_chosen || this.is_active){
					return hash_to_bg(this.id)
				}
				else{
					return "#DF1203"
				}
			},
			select(){
				this.was_chosen = true
				this.$emit('selected', this)
			}
		},
		mounted(){
			this.bg = this.getBg() 
		}
	})

	app.component("InnerLoop",{
	  	props:["kc"],
	  	template:`
	  	<div class="question_title comfortaa" :style="{ 'background-color': bg }"> 
			<span class="material-symbols-outlined lo_icon icon_header icon_active">architecture</span> Knowledge: {{ kc.title }}
		</div>
		<div class="task_container">
			<Interaction v-for="i in interactions"
				:kc_id=i.kc_id
				:type=i.type
				:student_text=i.student_text
				@submitted='handleSubmitted'
				@next_question="handleNext">
			</Interaction>
		</div>
	  	`,
	  	mounted(){
	  		this.bg = hash_to_bg(this.kc.id)
	  	
	  	},
	  	data(){
			return{
				bg: "",
				interactions:[{type:"question", kc_id:this.kc.id, student_text:""}]
			}
		},
		methods:{
			handleSubmitted(response){
				console.log(response)
				this.interactions.push({type:"feedback", kc_id:this.kc.id, student_text:response})
				
			},
			handleNext(){
				this.$emit("next_question")
			}
		}
	})

	
	app.component("Interaction", {
	 	props:['type', 'kc_id', 'student_text'],
	 	template:`
	 	<div class="question kode-mono-llm">
			{{ tutor_text }}	
		</div>
		
		<div v-if="student_ready" class="answer crimson-text-regular">
			
			<textarea class="answer_area crimson-text-regular" placeholder="Answer:" v-model="student_response"> </textarea>
			<div class="interaction "> <button @click="submit"> Submit </button> </div>
		</div>
		<div v-if="correct" class="answer comfortaa">
			<div class="interaction"> <button @click="next"> Next Question </button> </div>
		</div>
	 	`,
	 	methods:{
	 		async getQuestion(){
	  			
	  			const res = await fetch("http://127.0.0.1:5000/choose_kc", {method:"POST", body:this.kc_id})
				const finalRes = await res.json()
				
				for(letter of finalRes["question"]){
					await delay(20)
					this.tutor_text += letter
				}
				await delay(50)
				this.student_ready = true
	  		},

	  		async getFeedback(){
	  			
	  			
	  			res = await(fetch("http://127.0.0.1:5000/student_response", {method:"POST", body:this.student_text}))
				finalRes = await res.json()

				for(letter of finalRes["comment"]){
					await delay(20)
					this.tutor_text += letter
				}

				await delay(50)
				console.log(finalRes)
				switch(finalRes["grade"]){
					case "Correct":
						this.correct = true
						this.student_ready = false
						break

					case "Almost":
						this.student_ready = true
						break

					case "Incorrect":
						this.student_ready = true
						break

				}	
	  		},

	  		async submit(){
	  			this.$emit("submitted", this.student_response)
	  		},
	  		next(){
	  			this.$emit("next_question")
	  		}
	 	},
	 	mounted(){
	 		switch(this.type){
	 			case "question":
	 				this.getQuestion()
	 			case "feedback":
	 				this.getFeedback()
	 		}
	 	},
	 	data(){
	 		return{
	 			student_ready:false,
	 			submitted:false,
	 			correct:false,
	 			tutor_text:"",
	 			student_response:""

	 		}
	 	}
	})

	delay = ms => new Promise(res => setTimeout(res, ms));
	hash_to_bg = function(hash){
		switch( parseInt(hash)%3 ){
			case 0:
				return '#7aba99'
				break
			case 1:
				return '#b57f9b'
				break
			case 2:
				return '#7593af'
				break
			}		
		}

	//components:
	// lesson
	// 	knowledge_component_icon - KC
	// 	inner_loop
	//   interaction
	//     - question
	//     - hint
	//     - end


	app.mount('#app')

	</script>

	</body>
</html>